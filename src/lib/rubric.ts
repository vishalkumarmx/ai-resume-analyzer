const ACTION_VERBS=new Set(['built','led','designed','implemented','optimized','launched','automated','scaled','migrated','refactored','secured','instrumented','deployed','shipped','mentored'])
const SECTIONS=new Set(['summary','experience','education','skills','projects','certifications','achievements'])
export function score(resumeText:string,targetText:string){const text=(resumeText||'').toLowerCase();let pts=0;const reasons:string[]=[];let hasSections=0;SECTIONS.forEach(s=>{if(text.includes(s))hasSections++});const fmt=Math.min(15,hasSections*3);if(fmt<12)reasons.push('Add standard sections (Summary, Experience, Skills, Education).');pts+=fmt;const warnings:string[]=[];if(/\bobjective\b/.test(text))warnings.push("Use 'Summary' instead of 'Objective'.");if(/\bphoto\b|headshot|portrait/.test(text))warnings.push('Avoid photos; keep ATS-friendly text.');const atsPts=Math.max(0,25-5*warnings.length);pts+=atsPts;reasons.push(...warnings);const target=(targetText||'').toLowerCase();const kws=new Set((target.match(/[a-zA-Z][a-zA-Z0-9+\-.#]{2,}/g)||[]));let hits=0;kws.forEach(k=>{if(text.includes(k))hits++});const km=kws.size===0?0:Math.round(25*hits/Math.max(10,kws.size));pts+=km;if(km<18&&kws.size)reasons.push('Add more role keywords from the job description.');let impact=0;ACTION_VERBS.forEach(v=>{if(text.includes(v))impact=5});const metrics=/(\d+%|â‚¹?\d+[kKmM]?|\+\d+)/.test(resumeText||'')?10:0;pts+=impact+metrics;if(metrics===0)reasons.push('Quantify impact with numbers (% savings, revenue, users).');const longSentences=(resumeText||'').split('.').filter(s=>s.length>180).length;const grammarPts=Math.max(0,10-2*longSentences);pts+=grammarPts;if(grammarPts<8)reasons.push('Shorten long sentences; prefer punchy bullets.');let linksPts=0;if(/linkedin\.com|github\.com|portfolio|behance|dribbble/.test(text))linksPts+=6;if(/(email|@)/.test(text)&&/\+?\d/.test(text))linksPts+=4;else reasons.push('Ensure email and phone are visible; add LinkedIn/GitHub.');pts+=linksPts;return{score:Math.min(100,pts),reasons}}